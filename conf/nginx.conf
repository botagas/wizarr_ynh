#sub_path_only rewrite ^__PATH__$ __PATH__/ permanent;
location __PATH__/ {

    # Proxy to Wizarr application
    proxy_pass http://127.0.0.1:__PORT__/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Referer $http_referer;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Real-Port $remote_port;
    proxy_set_header X-Forwarded-Host $host:$server_port;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Ssl on;

    # For subpath installations only - rewrite content with absolute paths
    # This mirrors what Wizarr's Caddy example does
    #sub_path_only sub_filter 'href="/' 'href="__PATH__/';
    #sub_path_only sub_filter 'action="/' 'action="__PATH__/';
    #sub_path_only sub_filter '"/static' '"__PATH__/static';
    #sub_path_only sub_filter 'hx-post="/' 'hx-post="__PATH__/';
    #sub_path_only sub_filter 'hx-get="/' 'hx-get="__PATH__/';
    #sub_path_only sub_filter 'scan="/' 'scan="__PATH__/';
    #sub_path_only sub_filter '/scan' '__PATH__/scan';
    #sub_path_only sub_filter 'url + "/j/" + invite_code' 'url + "__PATH__/j/" + invite_code';
    #sub_path_only sub_filter_once off;
    #sub_path_only sub_filter_types text/html text/css text/javascript application/javascript;

    # Handle redirects for subpath installations only
    #sub_path_only proxy_redirect http://127.0.0.1:__PORT__/admin __PATH__/admin;
    #sub_path_only proxy_redirect http://127.0.0.1:__PORT__/setup __PATH__/setup;
    #sub_path_only proxy_redirect /admin __PATH__/admin;
    #sub_path_only proxy_redirect /setup __PATH__/setup;

    # Security headers
    more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
    more_set_headers "X-Content-Type-Options: nosniff";
    more_set_headers "X-XSS-Protection: 1; mode=block";
    more_set_headers "X-Permitted-Cross-Domain-Policies: none";
    more_set_headers "X-Frame-Options: DENY";
    
    # HTMX/AJAX support - allow same-origin requests
    more_set_headers "Access-Control-Allow-Origin: $scheme://$server_name";
    more_set_headers "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS";
    more_set_headers "Access-Control-Allow-Headers: Content-Type, X-Requested-With, HX-Request, HX-Target, HX-Current-URL";
    more_set_headers "Access-Control-Allow-Credentials: true";

    # Client uploads
    client_max_body_size 100M;

    # Include SSOWAT user panel
    include conf.d/yunohost_panel.conf.inc;
}
